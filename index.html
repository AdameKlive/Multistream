<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multistream</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            display: flex;
            justify-content: center;
            font-family: Arial, sans-serif;
            color: white;
        }
        #container {
            position: relative;
            width: 80%; /* Szeroko≈õƒá dla odtwarzaczy */
            display: flex;
            justify-content: space-between;
        }
        #kickPlayer {
            width: 1533px; /* Zgodnie z Twoim obecnym ustawieniem */
            height: calc(1533px * 9 / 16);
            background-color: black;
        }
        #twitchPlayer {
            position: absolute;
            width: 427px;
            height: 240px;
            top: 10px;
            left: 10px;
            border: 2px solid white;
            cursor: grab;
            z-index: 100; /* ZMIENIONO: Najwy≈ºszy z-index, aby player by≈Ç zawsze na wierzchu */
        }
        .controls {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px;
            border-radius: 5px;
            white-space: nowrap;
        }
        .controls button {
            background: white;
            border: none;
            padding: 5px;
            cursor: pointer;
            margin: 0 2px;
            border-radius: 3px;
        }
        #twitchPlayer:hover .controls {
            display: flex;
        }

        /* === Warstwowanie czatu === */
        #chatWrapper {
            width: 20%; /* Szeroko≈õƒá ca≈Çej sekcji czatu */
            height: 100vh;
            border-left: 2px solid white;
            position: relative; /* Wa≈ºne dla pozycjonowania dzieci */
            overflow: hidden; /* Ukryje wszelkie przepe≈Çnienia */
        }

        #twitchChatIframeOriginal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Pod customChatContainer, ale nadal na wierzchu, aby jego pole dzia≈Ça≈Ço */
            /* WA≈ªNE: Nie dodajemy tu pointer-events: none; Musi byƒá interaktywny. */
        }

        #customChatContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            /* WA≈ªNE: Zwiƒôkszamy wysoko≈õƒá, aby customowy czat ko≈Ñczy≈Ç siƒô WYRA≈πNIE POWY≈ªEJ pola do pisania Twitcha */
            /* Zwiƒôkszono z 110px na 130px. Warto≈õƒá do precyzyjnego dopasowania. */
            height: calc(100% - 130px); /* KLUCZOWA ZMIANA */
            z-index: 2; /* CustomChatContainer jest na wierzchu, ale NIE ZAS≈ÅANIA dolnego paska iframe'a Twitcha */
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a; /* Nieprzezroczyste t≈Ço, aby zakryƒá iframe pod spodem */
            padding: 10px;
            box-sizing: border-box;
            /* Usuniƒôto pointer-events: none; bo nie nachodzimy ju≈º na pole tekstowe, wiƒôc nie ma konfliktu */
        }

        #chatMessages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
            word-wrap: break-word;
            /* Usuniƒôto pointer-events: auto; bo domy≈õlne jest auto i nie potrzebujemy specjalnej regu≈Çy */
        }
        /* Ukrywamy input z custom chatu, bo u≈ºywamy tego z iframe'a Twitcha */
        #chatInputContainer {
            display: none;
        }
        .chat-message {
            margin-bottom: 5px;
            font-size: 14px;
        }
        .chat-message .username {
            font-weight: bold;
            margin-right: 5px;
        }
        .chat-message .emote {
            vertical-align: middle;
            height: 28px; /* Domy≈õlny rozmiar emotki 7TV, dostosuj */
            width: auto;
        }
        .chat-message .badge {
            vertical-align: middle;
            height: 18px; /* Rozmiar odznaki Twitcha */
            width: auto;
            margin-right: 3px;
        }
    </style>
</head>
<body>
    <div id="container">
        <iframe id="kickPlayer" src="https://player.kick.com/imbotmundrol" frameborder="0" allowfullscreen="true"></iframe>

        <div id="twitchPlayer">
            <iframe src="https://player.twitch.tv/?channel=adamekl&parent=film.adameklive.pl" frameborder="0" allowfullscreen width="100%" height="100%"></iframe>
            <div class="controls">
                <button id="shrink">‚ûñ</button>
                <button id="expand">‚ûï</button>
                <button id="move">üî≤</button>
            </div>
        </div>
    </div>

    <div id="chatWrapper">
        <iframe id="twitchChatIframeOriginal" src="https://www.twitch.tv/embed/adamekl/chat?parent=film.adameklive.pl" frameborder="0" allowfullscreen sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-modals"></iframe>

        <div id="customChatContainer">
            <div id="chatMessages">
                <div class="chat-message"><span class="username" style="color:#FFF;">System:</span> ≈ÅƒÖczenie z czatem...</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/tmi.js@1.8.5/tmi.min.js"></script>

    <script>
        // --- Kod do obs≈Çugi playera Twitcha (z Twojego oryginalnego kodu) ---
        const twitchPlayer = document.getElementById('twitchPlayer');
        const controls = document.querySelector('.controls');

        let minWidth = 213;
        let minHeight = 120;
        let maxWidth = 854;
        let maxHeight = 480;

        let isMoving = false;
        let offsetX, offsetY;

        function changeSize(delta) {
            let currentWidth = twitchPlayer.offsetWidth;
            let newWidth = currentWidth + delta;
            let newHeight = (newWidth * 9) / 16;

            newWidth = Math.min(Math.max(newWidth, minWidth), maxWidth);
            newHeight = Math.min(Math.max(newHeight, minHeight), maxHeight);

            twitchPlayer.style.width = `${newWidth}px`;
            twitchPlayer.style.height = `${newHeight}px`;
        }

        document.getElementById('shrink').addEventListener('click', () => changeSize(-42));
        document.getElementById('expand').addEventListener('click', () => changeSize(42));

        document.getElementById('move').addEventListener('mousedown', (e) => {
            isMoving = true;
            offsetX = e.clientX - twitchPlayer.offsetLeft;
            offsetY = e.clientY - twitchPlayer.offsetTop;
            document.body.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (isMoving) {
                requestAnimationFrame(() => {
                    let newLeft = e.clientX - offsetX;
                    let newTop = e.clientY - offsetY;

                    const containerRect = document.getElementById('container').getBoundingClientRect();
                    newLeft = Math.max(containerRect.left, Math.min(newLeft, containerRect.right - twitchPlayer.offsetWidth));
                    newTop = Math.max(containerRect.top, Math.min(newTop, containerRect.bottom - twitchPlayer.offsetHeight));

                    twitchPlayer.style.left = `${newLeft - containerRect.left}px`;
                    twitchPlayer.style.top = `${newTop - containerRect.top}px`;
                });
            }
        });

        document.addEventListener('mouseup', () => {
            isMoving = false;
            document.body.style.cursor = 'default';
        });

        twitchPlayer.addEventListener('mouseenter', () => {
            controls.style.display = 'flex';
        });

        twitchPlayer.addEventListener('mouseleave', () => {
            if (!isMoving) {
                controls.style.display = 'none';
            }
        });

        // --- Logika dla customowego czatu (bez serwera) ---
        const chatMessages = document.getElementById('chatMessages');

        const CHANNEL_NAME = 'adamekl'; // Kana≈Ç Twitcha, kt√≥ry chcesz obserwowaƒá

        let sevenTvGlobalEmotes = {};
        let sevenTvChannelEmotes = {};
        let bttvGlobalEmotes = {};
        let bttvChannelEmotes = {};
        let ffzChannelEmotes = {};

        // --- Funkcje do pobierania emotek z API ---
        async function fetchGlobal7TvEmotes() {
            try {
                const response = await fetch('https://api.7tv.app/v2/emotes/global');
                const data = await response.json();
                sevenTvGlobalEmotes = data.reduce((acc, emote) => {
                    // Wybierz odpowiedni rozmiar, np. 1x, 2x lub 3x (tutaj 2x)
                    const emoteUrl = emote.urls[1][1];
                    acc[emote.name] = emoteUrl;
                    return acc;
                }, {});
                console.log('Pobrano globalne emotki 7TV.');
            } catch (error) {
                console.error('B≈ÇƒÖd podczas pobierania globalnych emotek 7TV:', error);
            }
        }

        async function fetchGlobalBttvEmotes() {
            try {
                const response = await fetch('https://api.betterttv.net/3/cached/emotes/global');
                const data = await response.json();
                bttvGlobalEmotes = data.reduce((acc, emote) => {
                    acc[emote.code] = `https://cdn.betterttv.net/emote/${emote.id}/2x`; // 2x rozmiar
                    return acc;
                }, {});
                console.log('Pobrano globalne emotki BTTV.');
            } catch (error) {
                console.error('B≈ÇƒÖd podczas pobierania globalnych emotek BTTV:', error);
            }
        }

        async function fetchChannel7TvEmotes(twitchId) {
            if (!twitchId) return;
            try {
                const response = await fetch(`https://api.7tv.app/v2/users/${twitchId}/emotes`);
                const data = await response.json();
                if (data && data.emotes) {
                    sevenTvChannelEmotes = data.emotes.reduce((acc, emote) => {
                        const emoteUrl = emote.urls[1][1]; // 2x rozmiar
                        acc[emote.name] = emoteUrl;
                        return acc;
                    }, {});
                    console.log(`Pobrano emotki 7TV dla kana≈Çu ${CHANNEL_NAME}.`);
                }
            } catch (error) {
                console.error(`B≈ÇƒÖd podczas pobierania emotek 7TV dla kana≈Çu ${CHANNEL_NAME}:`, error);
            }
        }

        async function fetchChannelBttvEmotes(twitchId) {
            if (!twitchId) return;
            try {
                const response = await fetch(`https://api.betterttv.net/3/cached/users/twitch/${twitchId}`);
                const data = await response.json();
                if (data && data.channelEmotes) {
                    data.channelEmotes.forEach(emote => {
                        bttvChannelEmotes[emote.code] = `https://cdn.betterttv.net/emote/${emote.id}/2x`;
                    });
                }
                if (data && data.sharedEmotes) {
                    data.sharedEmotes.forEach(emote => {
                        bttvChannelEmotes[emote.code] = `https://cdn.betterttv.net/emote/${emote.id}/2x`;
                    });
                }
                console.log(`Pobrano emotki BTTV dla kana≈Çu ${CHANNEL_NAME}.`);
            } catch (error) {
                console.error(`B≈ÇƒÖd podczas pobierania emotek BTTV dla kana≈Çu ${CHANNEL_NAME}:`, error);
            }
        }

        async function fetchChannelFfzEmotes(twitchId) {
            if (!twitchId) return;
            try {
                const response = await fetch(`https://api.frankerfacez.com/v1/room/id/${twitchId}`);
                const data = await response.json();
                if (data && data.sets) {
                    for (const setId in data.sets) {
                        if (data.sets.hasOwnProperty(setId) && data.sets[setId].emoticons) {
                            data.sets[setId].emoticons.forEach(emote => {
                                // Wybieramy najlepszy dostƒôpny URL dla emotki
                                const emoteUrl = emote.urls['2'] || emote.urls['1']; // Preferujemy 2x, potem 1x
                                if (emoteUrl) {
                                    ffzChannelEmotes[emote.name] = `https:${emoteUrl}`; // FFZ czƒôsto zwraca wzglƒôdne URL
                                }
                            });
                        }
                    }
                    console.log(`Pobrano emotki FFZ dla kana≈Çu ${CHANNEL_NAME}.`);
                }
            } catch (error) {
                console.error(`B≈ÇƒÖd podczas pobierania emotek FFZ dla kana≈Çu ${CHANNEL_NAME}:`, error);
            }
        }

        // --- Funkcja do pobierania Twitch ID kana≈Çu (potrzebne dla emotek kana≈Çowych) ---
        async function getTwitchChannelId(channelName) {
            try {
                // !!! TWOJE KLIENT ID WPROWADZONE PONI≈ªEJ !!!
                const CLIENT_ID = 'xwsp0n38vqfrc8oh2w6eoaopun1sbg';

                const response = await fetch(`https://api.twitch.tv/helix/users?login=${channelName}`, {
                    headers: {
                        'Client-ID': CLIENT_ID
                    }
                });
                const data = await response.json();
                if (data.data && data.data.length > 0) {
                    console.log(`Pobrano Twitch ID dla ${channelName}: ${data.data[0].id}`);
                    return data.data[0].id;
                }
                return null;
            } catch (error) {
                console.error(`B≈ÇƒÖd podczas pobierania Twitch ID dla ${channelName}:`, error);
                return null;
            }
        }

        // --- Funkcja dodajƒÖca wiadomo≈õƒá do czatu ---
        function addChatMessage(username, message, color = '#FFFFFF', badges = {}) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message');

            // Dodaj odznaki
            if (badges.broadcaster) {
                const badgeImg = document.createElement('img');
                badgeImg.src = 'https://static-cdn.jtvnw.net/badges/v1/5527c58c-fb7d-4c79-b108-f34d17edd28d/1'; // Twitch broadcaster badge
                badgeImg.alt = 'Broadcaster';
                badgeImg.classList.add('badge');
                messageElement.appendChild(badgeImg);
            }
            if (badges.mod) {
                const badgeImg = document.createElement('img');
                badgeImg.src = 'https://static-cdn.jtvnw.net/badges/v1/3267646d-33f0-4b17-b3df-f923a41db174/1'; // Twitch mod badge
                badgeImg.alt = 'Moderator';
                badgeImg.classList.add('badge');
                messageElement.appendChild(badgeImg);
            }
            if (badges.vip) {
                const badgeImg = document.createElement('img');
                badgeImg.src = 'https://static-cdn.jtvnw.net/badges/v1/b817aba4-cedc-407b-ab00-80164cffbf70/1'; // Twitch VIP badge
                badgeImg.alt = 'VIP';
                badgeImg.classList.add('badge');
                messageElement.appendChild(badgeImg);
            }
            if (badges.sub) {
                 const badgeImg = document.createElement('img');
                 badgeImg.src = 'https://static-cdn.jtvnw.net/badges/v1/5d9f21f5-19a6-4297-b892-0b165842c55e/1'; // Przyk≈Çadowa odznaka subskrybenta (tier 1)
                 badgeImg.alt = 'Subscriber';
                 badgeImg.classList.add('badge');
                 messageElement.appendChild(badgeImg);
            }
            // Mo≈ºesz dodaƒá wiƒôcej odznak na podstawie `tags.badges` z TMI.js

            const usernameSpan = document.createElement('span');
            usernameSpan.classList.add('username');
            usernameSpan.style.color = color;
            usernameSpan.textContent = username + ': ';
            messageElement.appendChild(usernameSpan);

            // Parsowanie wiadomo≈õci pod kƒÖtem emotek
            const words = message.split(' ');
            words.forEach(word => {
                const emoteUrl = sevenTvChannelEmotes[word] || sevenTvGlobalEmotes[word] ||
                                 bttvChannelEmotes[word] || bttvGlobalEmotes[word] ||
                                 ffzChannelEmotes[word];

                if (emoteUrl) {
                    const emoteImg = document.createElement('img');
                    emoteImg.src = emoteUrl;
                    emoteImg.alt = word;
                    emoteImg.classList.add('emote');
                    messageElement.appendChild(emoteImg);
                } else {
                    messageElement.appendChild(document.createTextNode(word + ' '));
                }
            });

            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Przewi≈Ñ na d√≥≈Ç
        }

        // --- Inicjalizacja klienta tmi.js ---
        const client = new tmi.Client({
            channels: [CHANNEL_NAME]
        });

        // Po≈ÇƒÖcz siƒô z Twitch IRC
        client.connect().catch(error => {
            console.error('B≈ÇƒÖd po≈ÇƒÖczenia z Twitch IRC:', error);
            addChatMessage('System', 'B≈ÇƒÖd po≈ÇƒÖczenia z czatem Twitcha.', '#ff0000');
        });

        client.on('connected', (address, port) => {
            addChatMessage('System', `Po≈ÇƒÖczono z czatem Twitcha (${CHANNEL_NAME}).`);
            console.log(`Po≈ÇƒÖczono z Twitch IRC: ${address}:${port}`);

            getTwitchChannelId(CHANNEL_NAME).then(twitchId => {
                if (twitchId) {
                    fetchChannel7TvEmotes(twitchId);
                    fetchChannelBttvEmotes(twitchId);
                    fetchChannelFfzEmotes(twitchId);
                }
            });
        });

        // Nas≈Çuchiwanie wiadomo≈õci czatu
        client.on('message', (channel, tags, message, self) => {
            if (self) return; // Ignoruj w≈Çasne wiadomo≈õci (je≈õli kiedykolwiek zaimplementujesz wysy≈Çanie)

            const username = tags['display-name'] || tags.username;
            const userColor = tags.color || '#FFFFFF'; // Domy≈õlny bia≈Çy, je≈õli brak koloru
            const chatBadges = {
                mod: tags.mod,
                sub: tags.subscriber,
                vip: tags.vip,
                broadcaster: tags['user-id'] === tags['room-id']
            };

            addChatMessage(username, message, userColor, chatBadges);
        });

        client.on('disconnected', (reason) => {
            console.warn(`Roz≈ÇƒÖczono z Twitch IRC: ${reason}. Pr√≥ba ponownego po≈ÇƒÖczenia...`);
            addChatMessage('System', `Roz≈ÇƒÖczono z czatem Twitcha (${reason}). Pr√≥ba ponownego po≈ÇƒÖczenia...`, '#ffc107');
            // tmi.js powinien automatycznie pr√≥bowaƒá ponownie po≈ÇƒÖczyƒá
        });

        // --- Inicjalizacja pobierania emotek globalnych przy starcie strony ---
        fetchGlobal7TvEmotes();
        fetchGlobalBttvEmotes();
        // Globalne emotki FFZ nie sƒÖ obs≈Çugiwane przez API v1, tylko kana≈Çowe sƒÖ ≈Çatwo dostƒôpne.
    </script>
</body>
</html>
